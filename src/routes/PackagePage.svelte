<script>
	import { Router, Route, createHistory } from "svelte-navigator";
	import utils from "../utils";

	import Tabs from "../components/Tabs.svelte";
	import Tags from "../components/Tags.svelte";
	import Markdown from "../components/Markdown.svelte";
	import NavLink from "../components/NavLink.svelte";
	import GitLogo from "../components/GitLogo.svelte";

	export let fetchData;

        let maybeDescription = (pkg) => {
                if (pkg.description)
                        return pkg.description;
                else
                        return "";
        }

	async function fetchPkg(id) {
		return (await fetchData).find((_) => _.name === id);
	}

	async function fetchReadme(pkg) {
                return await fetch(
                        `https://astrolabe.pm/trees/${pkg.user}/${pkg.name}/${pkg.version}?path=README.md`
                ).then(response => response.blob())
                .then(blob => blob.text());
        }
</script>

<Route path=":id" let:params>
	<div class="package-page">
		{#await fetchPkg(params.id)}
			<h1>Fetching Packages...</h1>
		{:then pkg}
			<header>
                                <h2>{pkg.name} {pkg.version}</h2>
				<GitLogo gitUrl={pkg.source_url} height="64" />
			</header>
			<h3>
				<NavLink to="/author/{pkg.user}">{pkg.user}</NavLink>
			</h3>

			<Tags tags={pkg.tags} />

                        <p>{pkg.description ? pkg.description : ""}</p>

			<div class="install">
                                <Tabs user={pkg.user} name={pkg.name} />
			</div>

			<div class="sep" />

			{#await fetchReadme(pkg)}
				<h1>Fetching Readme</h1>
			{:then readme}
                                <Markdown md={readme} baseUrl={`https://astrolabe.pm/trees/${pkg.user}/${pkg.name}/${pkg.version}`}/>
			{/await}
		{:catch error}
			<p>Error: <code>{error}</code></p>
		{/await}
	</div>
</Route>

<style lang="scss">
	header {
		display: flex;
		justify-content: space-between;
	}

	.package-page {
		position: relative;
		padding: 20px;
	}

	h2 {
		margin: 0;
		font-size: 40pt;
	}

	h3 {
		margin-top: 0;
		color: #777;
		font-size: 16pt;
		font-weight: 500;

		:global(a) {
			color: #777;
		}
	}

	p {
		font-size: 14pt;
	}

	.install {
		display: flex;

		border: 2px solid var(--color-bg-1);
		border-radius: 5px;

		overflow: hidden;
	}

	.sep {
		margin-top: 20px;

		border-radius: 5px;

		width: 100%;
		height: 3px;
	}
</style>
